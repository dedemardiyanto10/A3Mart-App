name: Auto Update JSON on Release

on:
  release:
    types: [published]
  push:
    branches:
      - main  # Workflow akan jalan setiap kali kamu push ke main untuk testing
  workflow_dispatch: # Tombol manual

jobs:
  update-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Metadata & Size
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Ambil Tag (jika lewat release) atau default (jika lewat push)
          TAG="${{ github.event.release.tag_name }}"
          if [ -z "$TAG" ]; then TAG="v1.1.0"; fi 
          
          # Cari file APK
          ASSET_NAME=$(gh release view $TAG --json assets -q '.assets[] | select(.name | endswith(".apk")) | .name' | head -n 1 || echo "A3Mart_V1.1.0.apk")
          
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_ENV
          echo "TAG=$TAG" >> $GITHUB_ENV
          
          # Hitung tanggal
          echo "TODAY=$(date +'%d-%m-%Y')" >> $GITHUB_ENV
          
          # Hitung size (Jika file tidak ada karena bukan trigger release, default ke 4.5 MB)
          gh release download $TAG --pattern "$ASSET_NAME" --dir ./temp --clobber || echo "Download skipped"
          if [ -f "./temp/$ASSET_NAME" ]; then
            SIZE_BYTES=$(stat -c%s "./temp/$ASSET_NAME")
            SIZE_MB=$(python3 -c "print(f'{$SIZE_BYTES / (1024 * 1024):.1f} MB')")
            echo "FINAL_SIZE=$SIZE_MB" >> $GITHUB_ENV
          else
            echo "FINAL_SIZE=4.5 MB" >> $GITHUB_ENV
          fi

      - name: Update JSON File
        run: |
          python3 -c "
          import json, os

          filename = 'update.json'
          with open(filename, 'r') as f:
              data = json.load(f)

          tag = os.environ['TAG']
          asset = os.environ['ASSET_NAME']
          
          data['versionCode'] = data.get('versionCode', 0) + 1
          data['versionName'] = tag.replace('v', '')
          data['updateDate'] = os.environ['TODAY']
          data['fileSize'] = os.environ['FINAL_SIZE']
          data['downloadUrl'] = f'https://github.com/${{ github.repository }}/releases/download/{tag}/{asset}'
          
          with open(filename, 'w') as f:
              json.dump(data, f, indent=2)
          "

      - name: Push Updates
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add update.json
          git commit -m "Auto update version info" || echo "No changes to commit"
          git push

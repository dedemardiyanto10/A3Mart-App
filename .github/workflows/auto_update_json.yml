name: Auto Update JSON on Release

on:
  release:
    types: [published]

jobs:
  update-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Current Date
        id: date
        run: echo "date=$(date +'%d-%m-%Y')" >> $GITHUB_OUTPUT

      - name: Download Asset to Measure Size
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Mendownload file APK untuk menghitung ukuran aslinya
          # Sesuaikan '--pattern' jika nama file APK berbeda
          gh release download ${{ github.event.release.tag_name }} --pattern "*.apk" --dir ./downloads --clobber
          FILE_PATH=$(ls ./downloads/*.apk | head -n 1)
          FILE_SIZE_BYTES=$(stat -c%s "$FILE_PATH")
          echo "FILE_SIZE_MB=$(echo "scale=2; $FILE_SIZE_BYTES / 1048576" | bc) MB" >> $GITHUB_ENV

      - name: Update update.json
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
          CHANGELOG: ${{ github.event.release.body }}
          # Ganti 'A3Mart.apk' di bawah sesuai nama file yang kamu upload ke release
          DOWNLOAD_URL: "https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/A3Mart.apk"
        run: |
          python3 -c "
          import json
          import os

          filename = 'update.json'
          version_name = os.environ['TAG_NAME']
          clean_version = version_name.replace('v', '')
          
          # Baca file lama
          if os.path.exists(filename):
              with open(filename, 'r') as f:
                  data = json.load(f)
          else:
              data = {}

          # Update field sesuai struktur kamu
          data['versionCode'] = data.get('versionCode', 0) + 1
          data['versionName'] = clean_version
          data['updateDate'] = '${{ steps.date.outputs.date }}'
          data['fileSize'] = '${{ env.FILE_SIZE_MB }}'
          data['releaseType'] = 'Official Release'
          data['isForceUpdate'] = data.get('isForceUpdate', False)
          data['downloadUrl'] = os.environ['DOWNLOAD_URL']
          
          # Ambil changelog dari deskripsi release GitHub
          raw_changelog = os.environ.get('CHANGELOG', 'Peningkatan stabilitas.')
          data['changelog'] = f'Daftar Perubahan:\n\n{raw_changelog}'
          
          with open(filename, 'w') as f:
              json.dump(data, f, indent=2)
          "

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add update.json
          git commit -m "Chore: Auto update release info to $TAG_NAME"
          git push
